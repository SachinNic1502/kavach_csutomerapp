# Build Customer App with Kiosk Mode

## What This Enables

After activation:
- ✅ App hidden from launcher (stealth mode)
- ✅ When locked: Complete phone lockdown
  - No status bar/notification shade access
  - No home/back/recents buttons work
  - No camera, settings, or any other apps
  - Cannot factory reset
  - Only "Call Seller" button works

## Prerequisites

1. **Expo Account**: Sign up at https://expo.dev
2. **EAS CLI**: `npm install -g eas-cli`
3. **Android Device**: Physical device for testing (emulators don't support Device Owner)

## Build Steps

### 1. Install Dependencies
```bash
cd d:\Projects\kavach\customer-app
npm install
npx expo install @expo/config-plugins
```

### 2. Login to Expo
```bash
eas login
```

### 3. Configure EAS Build
```bash
eas build:configure
```

### 4. Start Build (APK)
```bash
eas build -p android --profile preview
```

This will:
- Upload your code to Expo servers
- Build the APK with native kiosk module
- Provide download link when done (~10-15 minutes)

### 5. Download & Install APK
- Download the APK from the link provided
- Transfer to Android device
- Install (enable "Install from unknown sources" if needed)

## Provision Device Owner (CRITICAL)

For kiosk mode to work, the app must be set as Device Owner. Do this BEFORE activating:

### Method 1: QR Code Provisioning (Easiest)
1. Factory reset the device
2. On setup screen, tap 6 times on "Welcome" text
3. Connect to WiFi
4. Scan this QR code (generate at https://qr-code-generator.com with JSON below)

```json
{
  "android.app.extra.PROVISIONING_DEVICE_ADMIN_COMPONENT_NAME": "com.devicelock.customer/.DeviceAdminReceiver",
  "android.app.extra.PROVISIONING_DEVICE_ADMIN_PACKAGE_DOWNLOAD_LOCATION": "https://your-apk-url.apk",
  "android.app.extra.PROVISIONING_SKIP_ENCRYPTION": true
}
```

### Method 2: ADB Command (For Testing)
```bash
# Connect device via USB with USB debugging enabled
adb devices

# Set as device owner
adb shell dpm set-device-owner com.devicelock.customer/.DeviceAdminReceiver
```

## Testing

1. **Install & Provision**: Install APK and set as Device Owner
2. **Activate**: Open app, scan QR or enter key
3. **App Hides**: After activation, app disappears from launcher
4. **Lock Test**: From seller app, send Lock command
5. **Verify Lockdown**:
   - Try swiping down (status bar blocked)
   - Try home button (blocked)
   - Try recent apps (blocked)
   - Try opening camera (blocked)
   - Only red lock screen visible with "Call Seller"
6. **Unlock Test**: From seller app, send Unlock
7. **Verify Normal**: Phone returns to normal, app still hidden

## Re-opening Hidden App

Since app is hidden after activation, to open it again:

### Option 1: Dialer Code
Call: `*#*#3562#*#*` (spells "DLCK")

### Option 2: ADB
```bash
adb shell am start -n com.devicelock.customer/.MainActivity
```

### Option 3: Settings
Settings → Apps → Show system apps → DeviceLock → Open

## Remove Device Owner (For Testing)

```bash
adb shell dpm remove-active-admin com.devicelock.customer/.DeviceAdminReceiver
```

Or factory reset the device.

## Native Module Code

The build will include this native Android code (auto-generated by config plugin):

**DeviceAdminReceiver.java**:
- Receives device admin events
- Enables Lock Task Mode
- Blocks factory reset

**DeviceAdminModule.java**:
- React Native bridge
- Exposes kiosk functions to JavaScript
- Manages app visibility and restrictions

## Troubleshooting

### "Not a device owner"
- Must provision BEFORE first activation
- Factory reset and re-provision

### "App not hiding"
- Check device admin is enabled: Settings → Security → Device admin apps
- Check logs: `adb logcat | grep DeviceLock`

### "Lock screen not blocking everything"
- Verify Lock Task Mode is active
- Check device owner status: `adb shell dumpsys device_policy`

## Production Deployment

For customer devices:
1. Build production APK: `eas build -p android --profile production`
2. Host APK on your server
3. Create QR codes with your APK URL
4. Factory reset customer devices
5. Provision via QR during setup
6. Customer activates with their key
7. App hides and locks down automatically

## Summary

- **Expo Go**: Soft lock only (back button, gestures blocked)
- **Native Build**: Full kiosk (everything blocked, app hidden)
- **Device Owner**: Required for true lockdown
- **Build Time**: ~15 minutes on EAS
- **Cost**: Free tier: 30 builds/month

Ready to build? Run: `eas build -p android --profile preview`
